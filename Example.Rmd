
---
title: "Main script Erik Vectra analysis"
output:
  html_document:
    toc: yes
---


```{r load_package}
source('spatstat_vectra.R')


base_path <- '../Exported data tables/' # Working for Yongsoo
base_path <- 'C:/Users/erikb/Documents/Thesis - Local/Data Marit voor Erik Bosch/Erik Bosch/Data complete phenotyping/HO105_Exported data tables/' # working for Erik
paths <- list_cell_seg_files(base_path)
paste("There are", length(paths), "paths currently loaded")


phenotype_complete = c("CD163+PDL1-","CD163+PDL1+",
                       "CD3+CD8-PD1-", "CD3+CD8-PD1+", "CD3+CD8+PD1-", "CD3+CD8+PD1+",
                       "Other","Other PDL1+",
                       "PAX5+PDL1-", "PAX5+PDL1+",
                       "")

color_complete = list("magenta", "brown",
                   "red", "blue", "green", "yellow",
                   "gray", "pink",
                   "orange", "cyan",
                   "gray")
names(color_complete) = phenotype_complete

fig.prefix.complete = './complete'

r_vec = c(10,20)


phenotype_simple = list(Macrophage = c("CD163+PDL1-","CD163+PDL1+"),
                      Tcells = c("CD3+CD8-PD1-", "CD3+CD8-PD1+", "CD3+CD8+PD1-", "CD3+CD8+PD1+"),
                      Tumors = c("PAX5+PDL1-", "PAX5+PDL1+"),
                      Others = c("Other", "Other PDL1+")
                      )

color_simple = c(Macrophage = "magenta", Tcells = "red", Tumors = "orange", Others = "gray")

fig.prefix.simple = './simple'
```


```{r HO105_extreme, fig.width=8, fig.height=8}
source('spatstat_vectra.R')
#base_path <- system.file("extdata", "samples", package = "phenoptrExamples")
extreme = paste0(base_path, c(
		'HO105-194_[16067,37856]_cell_seg_data.txt', # PD-L1 positive cluster + Tumor cluster
		'HO105-194_[15564,37856]_cell_seg_data.txt', # PD-L1 positive cluster + Tumor cluster
		'HO105-194_[16029,38205]_cell_seg_data.txt' # not clustered
	))


# Plot variables

plotter_sample = FALSE
plotter_quadrat = FALSE
plotter_alltypes = FALSE

plotter_bools = list(plotter_sample, plotter_quadrat, plotter_alltypes)

# Select spatial statistics, of NULL then all statistics are selected
selected_options = NULL

outputs = list()
for (file in extreme){
	print(paste('procesing', file))
    
	data = purrr::map_df(file, read_cell_seg_data, pixels_per_micron = getOption("phenoptr.pixels.per.micron"))
    
  	samplename = gsub('_cell_seg_data.txt', '', tail(strsplit(file, '/')[[1]],1))
	outputs[[samplename]] = do_analyse(Intable = data, PhenoOrder = phenotype_simple, ColsOrder = color_simple,
                      XposCol = 'Cell X Position', YposCol = 'Cell Y Position', PhenoCol = 'Phenotype',
                      sample_name = samplename, plotter = plotter_bools, fig.prefix = fig.prefix.simple, fig.width = 720, fig.height = 720,
                      r_vec = r_vec, options = selected_options, envelope = TRUE)
}
mat_output_dir = file.path(fig.prefix.simple, paste0(substr(samplename,1,9),'_output'))

M = feature_extract(outputs, mat_output_dir)
```

```{r marit HO105 image check  STDNR 3, fig.width=8, fig.height=8}
library('stringi')
source('spatstat_vectra.R')
studynrs = c(3,5,6,10,18,20,23,25,29,33,36,40,42,45,46,48,57,59,60,61,62,65,70,73,75,79,80,81,83,85,87,89,95,96,97,98,101,104,106,107,111,113,116,117,120,121,123,124,126,127,128,130,132,135,136,137,138,139,140,141,145,146,149,150,153,156,158,159,160,165,169,170,171,174,176,179,180,181,182,183,184,186,189,191,194,195,196,199,202)
studynrs0 = stri_pad_left(studynrs, pad = '0', width = 3)


# HO105-003
HOnr = paste0('HO105-', studynrs0[1])

tumor_images = c('[10769,37002]', '[10810,36653]', '[11564,35679]', '[11808,35330]', '[12707,36558]', '[12737,35493]', '[13300,37102]', '[14396,36315]')

combi = paste0(HOnr, '_', tumor_images)
pathcombi = paste0(base_path, combi,'_cell_seg_data.txt')

# Plot variables

plotter_sample = TRUE
plotter_quadrat = TRUE
plotter_alltypes = TRUE

plotter_bools = list(plotter_sample, plotter_quadrat, plotter_alltypes)

# Select spatial statistics, of NULL then all statistics are selected
selected_options = NULL

outputs = list()
for (file in pathcombi){
	print(paste('procesing', file))
    
	data = purrr::map_df(file, read_cell_seg_data, pixels_per_micron = getOption("phenoptr.pixels.per.micron"))
    
  	samplename = gsub('_cell_seg_data.txt', '', tail(strsplit(file, '/')[[1]],1))
	outputs[[samplename]] = do_analyse(Intable = data, PhenoOrder = phenotype_simple, ColsOrder = color_simple,
                      XposCol = 'Cell X Position', YposCol = 'Cell Y Position', PhenoCol = 'Phenotype',
                      sample_name = samplename, plotter = plotter_bools, fig.prefix = fig.prefix.simple, fig.width = 720, fig.height = 720,
                      r_vec = r_vec, options = selected_options, envelope = TRUE)
}
mat_output_dir = file.path(fig.prefix.simple, paste0(substr(samplename,1,9),'_output'))

M = feature_extract(outputs, mat_output_dir)
```

```{r marit HO105 image check  STDNR 60, fig.width=8, fig.height=8}
library('stringi')
source('spatstat_vectra.R')


# HO105-060
HOnr = paste0('HO105-', '060') # Cases with almost no immune cell infiltrate: HO105-060, HO105-062, HO105-065, HO105-184

tumor_images = c('[6798,47366]', '[9840,51007]', '[9966,49329]', '[10096,48980]', '[10432,49613]', '[19089,49960]', '[19134,52452]', '[19240,52103]', '[19619,49726]', '[19814,50933]', '[20215,51282]', '[20791,50292]')

combi = paste0(HOnr, '_', tumor_images)
pathcombi = paste0(base_path, combi,'_cell_seg_data.txt')

# Plot variables

plotter_sample = TRUE
plotter_quadrat = TRUE
plotter_alltypes = TRUE

plotter_bools = list(plotter_sample, plotter_quadrat, plotter_alltypes)

# Select spatial statistics, of NULL then all statistics are selected
selected_options = NULL

outputs = list()
for (file in pathcombi){
	print(paste('procesing', file))
    
	data = purrr::map_df(file, read_cell_seg_data, pixels_per_micron = getOption("phenoptr.pixels.per.micron"))
    
  	samplename = gsub('_cell_seg_data.txt', '', tail(strsplit(file, '/')[[1]],1))
	outputs[[samplename]] = do_analyse(Intable = data, PhenoOrder = phenotype_simple, ColsOrder = color_simple,
                      XposCol = 'Cell X Position', YposCol = 'Cell Y Position', PhenoCol = 'Phenotype',
                      sample_name = samplename, plotter = plotter_bools, fig.prefix = fig.prefix.simple, fig.width = 720, fig.height = 720,
                      r_vec = r_vec, options = selected_options, envelope = TRUE)
}

mat_output_dir = file.path(fig.prefix.simple, paste0(substr(samplename,1,9),'_output'))

M = feature_extract(outputs, mat_output_dir)

```
