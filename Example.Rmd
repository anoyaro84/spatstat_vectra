
---
title: "Main script Erik Vectra analysis"
output:
  html_document:
    toc: yes
---


```{r load_package}
library(reshape2)
source('spatstat_vectra.R')


base_path <- '../Exported data tables/' # Working for Yongsoo
base_path <- 'C:/Users/erikb/Documents/Thesis - Local/Data Marit voor Erik Bosch/Erik Bosch/Data complete phenotyping/HO105_Exported data tables/' # working for Erik
paths <- list_cell_seg_files(base_path)
paste("There are", length(paths), "paths currently loaded")


phenotype_complete = c("CD163+PDL1-","CD163+PDL1+",
                       "CD3+CD8-PD1-", "CD3+CD8-PD1+", "CD3+CD8+PD1-", "CD3+CD8+PD1+",
                       "Other","Other PDL1+",
                       "PAX5+PDL1-", "PAX5+PDL1+",
                       "")

color_complete = c("magenta", "brown",
                   "red", "blue", "green", "yellow",
                   "gray", "pink",
                   "orange", "cyan",
                   "gray")
names(color_complete) = phenotype_complete

fig.prefix.complete = './complete'

r_vec = c(10,20)


phenotype_simple = list(Macrophage = c("CD163+PDL1-","CD163+PDL1+"),
                      Tcells = c("CD3+CD8-PD1-", "CD3+CD8-PD1+", "CD3+CD8+PD1-", "CD3+CD8+PD1+"),
                      Tumors = c("PAX5+PDL1-", "PAX5+PDL1+"),
                      Others = c("Other", "Other PDL1+")
                      )

color_simple = c(Macrophage = "magenta", Tcells = "red", Tumors = "orange", Others = "gray")

fig.prefix.simple = './simple'
```


```{r HO105_extreme, fig.width=8, fig.height=8}
source('spatstat_vectra.R')
#base_path <- system.file("extdata", "samples", package = "phenoptrExamples")
extreme = paste0(base_path, c(
		'HO105-194_[16067,37856]_cell_seg_data.txt', # PD-L1 positive cluster + Tumor cluster
		'HO105-194_[15564,37856]_cell_seg_data.txt', # PD-L1 positive cluster + Tumor cluster
		'HO105-194_[16029,38205]_cell_seg_data.txt' # not clustered
	))


# Plot variables

plotter_sample = FALSE
plotter_quadrat = TRUE
plotter_alltypes = TRUE

plotter_bools = c(plotter_sample, plotter_quadrat, plotter_alltypes)

# Select spatial statistics, of NULL then all statistics are selected
selected_options = NULL

outputs = list()
for (file in extreme){
	print(paste('procesing', file))
    
	data = purrr::map_df(file, read_cell_seg_data, pixels_per_micron = getOption("phenoptr.pixels.per.micron"))
    
  	samplename = gsub('_cell_seg_data.txt', '', tail(strsplit(file, '/')[[1]],1))
	outputs[[samplename]] = do_analyse(Intable = data, PhenoOrder = phenotype_simple, ColsOrder = color_simple,
                      XposCol = 'Cell X Position', YposCol = 'Cell Y Position', PhenoCol = 'Phenotype',
                      sample_name = samplename, plotter = plotter_bools, fig.prefix = fig.prefix.simple, fig.width = 720, fig.height = 720,
                      r_vec = r_vec, options = selected_options, envelope = TRUE)
}
```

```{r extreme_cases, eval=F, outdated}

pheno_vector_absolut = c("CD163+PDL1-","CD163+PDL1+","CD3+CD8-PD1-", "CD3+CD8-PD1+", "CD3+CD8+PD1-", "CD3+CD8+PD1+","Other","Other PDL1+","PAX5+PDL1-", "PAX5+PDL1+")
Cols = c("magenta","brown","red","blue","green","yellow","gray","pink","orange","cyan")

# HO105-194
sample_name = "HO105-194_[16067,37856].im3" # PD-L1 positive cluster + Tumor cluster
out = do_analyse(merged_filtered_with_distance %>% filter(`Sample Name` == sample_name), 
	   PhenoOrder = pheno_vector_absolut, Cols = Cols, plotter = TRUE)
sample_name = "HO105-194_[15564,37856].im3" # PD-L1 positive cluster + Tumor cluster
out = do_analyse(merged_filtered_with_distance %>% filter(`Sample Name` == sample_name), 
	   PhenoOrder = pheno_vector_absolut, Cols = Cols, plotter = TRUE)
sample_name = "HO105-194_[16029,38205].im3" # not clustered
out = do_analyse(merged_filtered_with_distance %>% filter(`Sample Name` == sample_name), 
	   PhenoOrder = pheno_vector_absolut, Cols = Cols, plotter = TRUE)

```

