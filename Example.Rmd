
---
title: "Main script Erik Vectra analysis"
output:
  html_document:
    toc: yes
---


```{r load_package}
source('spatstat_vectra.R')


base_path <- '../Exported data tables/' # Working for Yongsoo
base_path <- path.expand('~/Thesis - Local/Data Marit voor Erik Bosch/Erik Bosch/Data complete phenotyping') # working for Erik
paths_to_seg <- list_cell_seg_files(base_path)
paste("There are", length(paths_to_seg), "segmentation paths currently loaded")


phenotype_complete = c("CD163+PDL1-","CD163+PDL1+",
                       "CD3+CD8-PD1-", "CD3+CD8-PD1+", "CD3+CD8+PD1-", "CD3+CD8+PD1+",
                       "Other","Other PDL1+",
                       "PAX5+PDL1-", "PAX5+PDL1+",
                       "")

color_complete = list("magenta", "brown",
                   "red", "blue", "green", "yellow",
                   "gray", "pink",
                   "orange", "cyan",
                   "gray")
names(color_complete) = phenotype_complete

fig.prefix.complete = './complete'

r_vec = c(30)


phenotype_simple = list(Macrophage = c("CD163+PDL1-","CD163+PDL1+"),
                      Tcells = c("CD3+CD8-PD1-", "CD3+CD8-PD1+", "CD3+CD8+PD1-", "CD3+CD8+PD1+"),
                      Tumors = c("PAX5+PDL1-", "PAX5+PDL1+"),
                      Others = c("Other", "Other PDL1+")
                      )

color_simple = c(Macrophage = "magenta", Tcells = "red", Tumors = "orange", Others = "gray")

fig.prefix.simple = './simple'
```


```{r HO105_extreme,fig.width=8, fig.height=8} 
source('spatstat_vectra.R') #fig.width=8, fig.height=8
#base_path <- system.file("extdata", "samples", package = "phenoptrExamples")
extreme = file.path(base_path, c(
		'HO105-194_[16067,37856]_cell_seg_data.txt', # PD-L1 positive cluster + Tumor cluster
		'HO105-194_[15564,37856]_cell_seg_data.txt', # PD-L1 positive cluster + Tumor cluster
		'HO105-194_[16029,38205]_cell_seg_data.txt' # not clustered
	))
extreme = file.path(base_path, c(
		'HO105-194_[16067,37856]_cell_seg_data.txt' # PD-L1 positive cluster + Tumor cluster
	))
# Plot variables

plotter_sample = TRUE
plotter_quadrat = TRUE
plotter_alltypes = TRUE

plotter_bools = list(plotter_sample, plotter_quadrat, plotter_alltypes)

# Select spatial statistics, or NULL then all inbuild spatial statistics are selected
selected_spatstat_statistics = NULL


outputs_auto = list()
for (file in extreme){
	print(paste('procesing', file))
    
  	samplename = gsub('_cell_seg_data.txt', '', tail(strsplit(file, '/')[[1]],1))
	outputs_auto[[samplename]] = do_analyse(segmentation_path = file, PhenoOrder = phenotype_complete, ColsOrder = color_complete,
                      XposCol = 'Cell X Position', YposCol = 'Cell Y Position', PhenoCol = 'Phenotype',
                      sample_name = samplename, plotter = plotter_bools, fig.prefix = fig.prefix.complete,
                      r_vec = r_vec, spatstat_statistics = selected_spatstat_statistics)
}
```


```{r marit HO105 image check  all via import, fig.width=8, fig.height=8}
source('spatstat_vectra.R')
library('readxl')


#### Preprocessing ####
# Define path for all data
base_path <- '../Exported data tables/' # Working for Yongsoo
# base_path <- 'C:/Users/erikb/Documents/Thesis - Local/Data Marit voor Erik Bosch/Erik Bosch/Data complete phenotyping' # working for Erik
base_path = path.expand("~/Thesis - Local/Data Marit voor Erik Bosch/Erik Bosch/Data complete phenotyping")

# define path for selected images by Marit
image_check_path = NULL # working for Yongsoo (CHANGE)
image_check_path <- 'C:/Users/erikb/Documents/Thesis - Local/spatstat_vectra/HO105 image check.xlsx' # working for Erik
image_check_path <- path.expand('~/spatstat_vectra/HO105 image check.xlsx') # working for Erik


#### renaming all files in directory with '_1_', '_2_', '_3_' and '_4_' (replace with '_') ####
all_files_x_ = list.files(base_path, pattern =  'HO105-',full.names = TRUE)
names_with_x_ = list.files(base_path, pattern =  'HO105-[0-9]+_[0-9]_',full.names = TRUE)

if (length(names_with_x_)>0){
    new_names = str_replace_all(all_files_x_, pattern = '_[0-9]_', replacement = '\\_')
    warning(paste('file names have been renamed in the current directory',getwd()))
    rename_log = file.rename(all_files_x_, new_names)
}





#### Read file for selected images by Marit ####
HO105_image_check <- read_excel(image_check_path)

HOnrs_unfil = HO105_image_check$`HO105 nr`
tumor_images_data_unfil = HO105_image_check$`Tumor images`
# get the MSI's through regex finding: open bracket->MSI numbers->comma->MSI numbers-> closed bracket
tumor_images_unfil = str_extract_all(tumor_images_data_unfil,'\\[[0-9]+,[0-9]+\\]')
# create filter to check for non empty content
non_empty = !sapply(tumor_images_unfil,is_empty)
# create filtered tumor_images and HOnrs
tumor_images = tumor_images_unfil[non_empty]
HOnrs = HOnrs_unfil[non_empty]
names(tumor_images) = HOnrs
# create string with paths to segmentation data and component data to analyse
sample_names_marit = lapply(seq_along(HOnrs),function(x) paste0(names(tumor_images)[x],'_',unlist(tumor_images[HOnrs][x])))
sample_names_marit_str = unlist(sample_names_marit)
length(sample_names_marit_str)



#### check if the component data and segmentation data are one to one ####
# # find all files of HO105
# all_files = list.files(base_path, pattern =  'HO105-')

## find all available component data of HO105
available_comp_tif = list.files(base_path, pattern = '_component_data.tif')
# find the sample names of all available component data
available_comp = lapply(available_comp_tif, function(x) gsub('_component_data.tif','',x))
available_comp_str = unlist(available_comp)
length(available_comp_str)

## find all available segmentation data of HO105
available_seg_txt = list.files(base_path, pattern = '_cell_seg_data.txt')
# find the sample names of the all available segmentation data
available_seg = lapply(available_seg_txt, function(x) gsub('_cell_seg_data.txt','',x))
available_seg_str = unlist(available_seg)
length(available_seg_str)


# take intersection to retrieve the matching names with the data from Marits file
matching_names_marit = intersect(sample_names_marit_str,available_comp_str)
length(matching_names_marit)

# take the difference to retrieve the sample names of the missing component data
diff_available_comp = setdiff(sample_names_marit_str,available_comp_str)
length(diff_available_comp)

#take set difference of names of actual available components and names of components of 
diff_available_seg = setdiff(sample_names_marit_str,available_seg_str)
length(diff_available_seg)


pathcombi = paste0(base_path,matching_names_marit,'_cell_seg_data.txt')


# Plot variables

plotter_sample = TRUE
plotter_quadrat = TRUE
plotter_alltypes = TRUE

plotter_bools = list(plotter_sample, plotter_quadrat, plotter_alltypes)

# Select spatial statistics, of NULL then all statistics are selected
selected_spatstat_statistics = NULL

outputs = list()
for (file in pathcombi){
	print(paste('procesing', file))
    
  	samplename = gsub('_cell_seg_data.txt', '', tail(strsplit(file, '/')[[1]],1))
	outputs[[samplename]] = do_analyse(segmentation_path = file, PhenoOrder = phenotype_simple, ColsOrder = color_simple,
                      XposCol = 'Cell X Position', YposCol = 'Cell Y Position', PhenoCol = 'Phenotype',
                      sample_name = samplename, plotter = plotter_bools, fig.prefix = fig.prefix.simple,
                      r_vec = r_vec, spatstat_statistics = selected_spatstat_statistics)
}
```