
---
title: "Main script Erik Vectra analysis"
output:
  html_document:
    toc: yes
---


```{r load_package}
library(reshape2)
source('spatstat_vectra.R')
base_path <- '../../data/Exported data tables/'
paths <- list_cell_seg_files(base_path)
paste("There are", length(paths), "paths currently loaded")


pheno_vector_absolut = c("CD163+PDL1-","CD163+PDL1+","CD3+CD8-PD1-", "CD3+CD8-PD1+", "CD3+CD8+PD1-", "CD3+CD8+PD1+","Other","Other PDL1+","PAX5+PDL1-", "PAX5+PDL1+")

colors_absolut = c("magenta", "brown", "red", "blue", "green", "yellow", "gray", "pink", "orange", "cyan")
names(colors_absolut) = pheno_vector_absolut
r_vec = c(10,20)

```


```{r HO105_extreme, fig.width=8, fig.height=8}
#base_path <- system.file("extdata", "samples", package = "phenoptrExamples")
extreme = paste0(base_path, c(
		'HO105-194_[16067,37856]_cell_seg_data.txt', # PD-L1 positive cluster + Tumor cluster
		'HO105-194_[15564,37856]_cell_seg_data.txt', # PD-L1 positive cluster + Tumor cluster
		'HO105-194_[16029,38205]_cell_seg_data.txt' # not clustered
	))


outputs = list()
for (file in extreme){
	print(paste('procesing', file))

	data = purrr::map_df(file, read_cell_seg_data, pixels_per_micron = getOption("phenoptr.pixels.per.micron"))
	data_with_distance = data %>%
	  do(bind_cols(., find_nearest_distance(.)))

  	samplename = gsub('_cell_seg_data.txt', '', tail(strsplit(file, '/')[[1]],1))
	outputs[[samplename]] = do_analyse(data_with_distance, pheno_vector_absolut, colors_absolut, 
			    NULL, plotter = c(TRUE, TRUE,TRUE),XposCol = 'Cell X Position', envelope=TRUE, 
			    fig.prefix = './', fig.width = 720, fig.height = 720,
			    YposCol = 'Cell Y Position',PhenoCol = 'Phenotype', samplename, r_vec = r_vec)
}
```

```{r extreme_cases, eval=F}

pheno_vector_absolut = c("CD163+PDL1-","CD163+PDL1+","CD3+CD8-PD1-", "CD3+CD8-PD1+", "CD3+CD8+PD1-", "CD3+CD8+PD1+","Other","Other PDL1+","PAX5+PDL1-", "PAX5+PDL1+")
Cols = c("magenta","brown","red","blue","green","yellow","gray","pink","orange","cyan")

# HO105-194
sample_name = "HO105-194_[16067,37856].im3" # PD-L1 positive cluster + Tumor cluster
out = do_analyse(merged_filtered_with_distance %>% filter(`Sample Name` == sample_name), 
	   PhenoOrder = pheno_vector_absolut, Cols = Cols, plotter = TRUE)
sample_name = "HO105-194_[15564,37856].im3" # PD-L1 positive cluster + Tumor cluster
out = do_analyse(merged_filtered_with_distance %>% filter(`Sample Name` == sample_name), 
	   PhenoOrder = pheno_vector_absolut, Cols = Cols, plotter = TRUE)
sample_name = "HO105-194_[16029,38205].im3" # not clustered
out = do_analyse(merged_filtered_with_distance %>% filter(`Sample Name` == sample_name), 
	   PhenoOrder = pheno_vector_absolut, Cols = Cols, plotter = TRUE)

```

