
---
title: "Example Vectra image analysis"
output:
  html_document:
    toc: yes
---


## Loading packages


```{r load_package}
library(cowplot)
library(ggplot2)
source('spatstat_vectra.R')

plot_function <- function(csd, ctypes) {
    plt <- ggplot() + theme_bw() + 
           geom_point(data = csd[grep('Other', csd$Phenotype),],
               aes(x=x, y=y), col = '#b5b3ae', size=2.5) +
        geom_point(data = csd[csd$Phenotype%in%c('PAX5+PDL1-','PAX5+PDL1+'),],
               aes(x=x, y=y), col = '#fc8105', size=2.5) +
           geom_point(data = csd[grep('PAX5+PDL1+', csd$Phenotype, fixed=T),],
               aes(x=x, y=y), col = '#fff761', size=0.01, shape=1, stroke=1) + 
           geom_point(data = csd[grep('CD3+CD8-',csd$Phenotype, fixed=T),],
               aes(x=x, y=y), col = '#34c9eb', size=2.5) +
           geom_point(data = csd[grep('CD3+CD8+',csd$Phenotype, fixed=T),],
               aes(x=x, y=y), col = '#4634eb', size=2.5) +
            geom_point(data = csd[grep('PD1+', csd$Phenotype, fixed=T),],
               aes(x=x, y=y), col = '#fff761', size=0.01,shape=1, stroke=1) + 
           geom_point(data = csd[grep('CD163', csd$Phenotype),],
               aes(x=x, y=y), col = '#a834eb', size=2.5) +
           geom_point(data = csd[grep('CD163+PDL1+', csd$Phenotype, fixed=T),],
               aes(x=x, y=y), col = '#fff761', size=0.01, shape=1, stroke=1) 
    return(plt +theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
                   panel.background = element_blank()))
}

```

## Example images (5 images)


```{r example_images, fig.width=12, fig.height=6}

images = c(
    'exported_mIF/HO105-003_[11564,35679]_cell_seg_data.txt',
    'exported_mIF/HO105-003_[11564,35679]_cell_seg_data.txt',
    'exported_mIF/HO105-025_[9621,46812]_cell_seg_data.txt',
    'exported_mIF/HO105-182_[8076,47954]_cell_seg_data.txt',
    'exported_mIF/HO105-020_[9758,38701]_cell_seg_data.txt'
)

ctypepairs = list(
    c('CD3+CD8-PD1-', 'CD8+CD8-PD1+', 'CD3+CD8+PD1-', 'CD3+CD8+PD1+'),
    c('CD163+PDL1-', 'CD163+PDL1+', 'CD3+CD8+PD1-', 'CD3+CD8+PD1+'),
    c('CD163+PDL1-', 'CD163+PDL1+'),
    c('CD163+PDL1-', 'CD163+PDL1+'),
    c('CD163+PDL1-', 'CD163+PDL1+')
                  )


XposCol = 'Cell X Position'
YposCol = 'Cell Y Position'
PhenoCol = 'Phenotype'

#i=1
for (i in 1:length(images)) {
    plist = list()
    Table <- purrr::map_df(images[i], read_cell_seg_data, 
                       pixels_per_micron = "auto", remove_units=FALSE)

    # replace empty phenotype with "Other"
    Table$Phenotype[Table$Phenotype == ""] = "Other"
  
    # define csd for ppp
    csd <- as.data.frame(Table[, c(PhenoCol, XposCol, YposCol)])
    colnames(csd) = c('Phenotype', 'x',  'y')

    plt1 <- local({

        plt1 = plot_function(csd, c('Tumor', 'Tcell', 'Macrophage', 'Other'))
        #plt <- plt + ggtitle(images[i]) 
        plt1 <- plt1 + #ggtitle(images[i]) + 
          theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
                axis.title.x=element_blank(), axis.text.x=element_blank(),
                axis.ticks.x=element_blank(), axis.title.y=element_blank(), 
                axis.text.y=element_blank(), axis.ticks.y=element_blank(),
                panel.background = element_blank()) + ggtitle('all cell types')# + scale_y_reverse()
        return(plt1)
    })

    #print(plt1)    
    xlims <- layer_scales(plt1)$x$get_limits()
    ylims <- layer_scales(plt1)$y$get_limits()

    csd2 <- csd
    plt2 <- plot_function(csd2[csd2$Phenotype%in%ctypepairs[[i]],], 
                         c('Tumor', 'Tcell', 'Macrophage', 'Other')) + 
           xlim(xlims) + ylim(ylims)# + scale_y_reverse()
    plt2 <- plt2 + 
          theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
                axis.title.x=element_blank(), axis.text.x=element_blank(),
                axis.ticks.x=element_blank(), axis.title.y=element_blank(), 
                axis.text.y=element_blank(), axis.ticks.y=element_blank(),
                panel.background = element_blank()) + 
           ggtitle(paste0('focus: ', paste0(ctypepairs[[i]], collapse='/')))# + scale_y_reverse() 

    plot_row <- plot_grid(plt1, plt2)

    title <- ggdraw() +
        draw_label(
                   images[i],
                   fontface = 'bold',
                   x = 0,
                   hjust = 0
                   ) +
           theme(
                 plot.margin = margin(0,0,0,7)
                 )
    
    print(plot_grid(title, plot_row, ncol=1, rel_heights = c(0.1,1)))
}


```

## Visualization of the images


```{r, eval=T, cache=T, warning=F, message=F}

phenotype_complete = c("CD163+PDL1-","CD163+PDL1+",
                       "CD3+CD8-PD1-", "CD3+CD8-PD1+", "CD3+CD8+PD1-", "CD3+CD8+PD1+",
                       "Other","Other PDL1+", "PAX5+PDL1-", "PAX5+PDL1+", "")

color_complete = list("magenta", "brown",
                   "red", "blue", "green", "yellow",
                   "gray", "pink", "orange", "cyan", "gray")
names(color_complete) = phenotype_complete

fig.prefix.complete = './complete'
selected_spatstat_statistics = c('K', 'L') 
# can be any subset of ('K', 'Kdot', 'L', 'Ldot', 'F', 'J', 'G', 'Gdot', 'pcf')
r_vec = c(5, 10, 25, 50, 75, 100)

plotter_sample = T
plotter_quadrat = T
plotter_alltypes = T

plotter = list(plotter_sample, plotter_quadrat, plotter_alltypes)

outputs_complete = list()
for (file in images){
	cat('processing', file)
  
  samplename = gsub('_cell_seg_data.txt', '', tail(strsplit(file, '/')[[1]],1))
  outputs_complete[[samplename]] = do_analyse(seg_path = file, PhenoOrder = phenotype_complete, 
                                          ColsOrder = color_complete, XposCol = 'Cell X Position', 
                                          YposCol = 'Cell Y Position', PhenoCol = 'Phenotype',
                      sample_name = samplename, plotter = plotter, fig.prefix = fig.prefix.complete,
                      r_vec = r_vec, spatstat_statistics = selected_spatstat_statistics)
}

```

The script `do_analyse` measures multiple statistics (`K` and `L` statistics were chosen in the example above) for the given image (`seg_path`).
Apart from the statistics itself, it will save images at the location specified by `fig.prefix`. 
One example image (K statistics) of all pairs of cell types considered (defined by `PhenoOrder`) is shown below. Note that `+` and `-` signs are converted to `T` and `F`. 
The red line and gray shadow indicate theoretical statistics when the pair of cell types have no geometric association. The solid black line represents the actual statistic.

![Example image](./complete/HO105-003_[11564,35679]/HO105-003_[11564,35679]_statistic_K.png)


## Creating a feature matrix

Feature matrix can be created with `feature_extract` function.


```{r feature}

mat = feature_extract(outputs_complete)
df = data.frame(feature = colnames(mat), stringsAsFactors=F)

# some features are excluded in the study
keyword_exclude = c('counts_sample', 'counts_lognormed', 'counts_pairwise', 'counts_pairwise', 
        'density_lognormed', 'density_lognormed', 'Ldot_', 'Kdot_', 'pcf_')

df$Use = rep(TRUE, ncol(mat))

for (key in keyword_exclude) {
    df$Use[grep(key, colnames(mat))] = FALSE
}

# unnormalized spatial features were also excluded
ind_unnormalized = setdiff(grep('radius', df$feature), grep('Normalized', df$feature))
df[ind_unnormalized, 'Use'] = FALSE



# feature annotation

df$celltype = unlist(lapply(df$feature, function(x) tail(strsplit(x, '_', fixed=T)[[1]],1)))
df$celltype = unlist(lapply(df$celltype,
                    function(x) paste0(sort(strsplit(x, '/')[[1]]), collapse='/')
                    ))

feat_key = c(count='counts_[a-z]+', density='density_', Xstat='X2stat_[a-z]', MedianDistance='MED|distance_ratio',
        RelDistance = 'Relative_distance', MADDistance='MAD', Fstat='F_radius', Gstat='G_radius|Gdot_radius', 
        Kstat='K_radius|Kdot_radius', Lstat='L_radius|Ldot_radius', PCFstat='pcf_radius')


ctype_key = grep('counts_sample', df$feature, value=T)
ctype_key = unlist(lapply(ctype_key, function(x) tail(strsplit(x, '_', fixed=T)[[1]], 1)))

df$feat_group = NA
for (i in 1:length(feat_key)) {
    df$feat_group[grep(feat_key[i], df$feature)] = names(feat_key)[i] 
}
for (i in 1:length(ctype_key)) {
    df[[ctype_key[i]]] = FALSE
    df[[ctype_key[i]]][grep(ctype_key[i], df$feature, fixed=T)] = TRUE
    for (overlap in setdiff(grep(ctype_key[i], ctype_key, value=T, fixed=T), ctype_key[i])) {
        df[[ctype_key[i]]][grep(overlap, df$feature, fixed=T)] = FALSE
    }
}

for (radius in c(5,10, 25, 50, 75, 100, 150, 200, 250, 500)) {
    ind = grep(paste0('radius ', as.character(radius), '_'), df$feature)
    df$feat_group[ind] = paste0(df$feat_group[ind], ', r=', as.character(radius))
}
#

```

## Feature overview


```{r}

color = c(
          "NonSpatial" = "#72ac5c",
          "GlobalSpatial" = "#7f64b9",
          "LocalSpatial" = "#bb7438",
          "Poisson, r_5" = "#c2215f",
          "Poisson, r_10" = "#c76f90",
          "Poisson, r_25" = "#da9eb4",
          "Poisson, r_50" = "#e2b2c3",
          "Poisson, r_75" = "#f2dee5",
          "Poisson, r_100" = "#f7ecf0",
          "Poisson, local" = "#c2215f",
          "Poisson, global" = "#e2b2c3"
          )


freq = data.frame(table(df[df$Use, ]$feat_group))

ftypes = list(
    NonSpatial=c("count", "density"),
    GlobalSpatial=c("MAD_Distance", "Median_Distance", 'Xstat'),
    LocalSpatial=c("MAD_Min_Distance", "Median_Min_Distance", "RelDistance")
    )
radius = list(local=c(5, 10, 25), global=c(50, 75, 100)) 

for (r in 1:length(radius)) {
    feats = c()
    for (rs in radius[[r]]) {
        feats = c(feats, grep(paste0('r=', as.character(rs), '$'), df$feat_group, value=T))
    }
    ftypes[[paste0('Poisson, ',names(radius)[r])]] = unique(feats)
}

freq$category = NA
for (i in 1:length(ftypes)){
    freq$category[freq$Var1%in%ftypes[[i]]] = names(ftypes)[i]
}

freq$category = factor(freq$category, levels =names(ftypes))
freq$Feat = unlist(lapply(freq$Var1, function(x) strsplit(as.character(x), ',')[[1]][1]))
freq$Feat = gsub('_', ' ', freq$Feat, fixed=T)
freq$Var1 = factor(freq$Var1, levels=freq$Var1[order(freq$category)])
freq$Feat = factor(freq$Feat, levels=unique(freq$Feat[order(freq$category)]))
ggplot(freq[!is.na(freq$category),], aes(x=Feat, y=Freq, fill=category)) + geom_bar(stat='identity') + theme_bw() +
    theme(axis.text.x = element_text(angle=90, vjust=1, hjust=1)) + scale_fill_manual(values=color) + 
    xlab("Feature type") + ylab("# of features")

```



## Session Information

```{r session}
sessionInfo()
```

