---
title: "Main script Erik Vectra analysis"
output:
  html_document:
    toc: yes
---

```{r source files, echo=FALSE}
source('spatstat_vectra.R')

```

```{r RUN import files method Erik dependent on .Rdata, echo=FALSE, eval=FALSE}
######### RUN import files method Erik#########

paths <- list_cell_seg_files(
  "C:/Users/erikb/Documents/Thesis - Local/Data Marit voor Erik Bosch/Erik Bosch/Data complete phenotyping/HO105_Exported data tables"
)
paste("There are", length(paths), "different samples currently available.")

data = purrr::map_df(paths, read_cell_seg_data, pixels_per_micron = getOption("phenoptr.pixels.per.micron"))
paste("dimensions of the data is", dim(data)[1], "times", dim(data)[2]) # 1805834 197

data_with_distance = data %>%
  do(bind_cols(., find_nearest_distance(.)))
paste("dimensions of the data is", dim(data_filtered_with_distance)[1], "times", dim(data_filtered_with_distance)[2])

data_filtered = data %>% filter(Phenotype != "")
paste("dimensions of the data is", dim(data_filtered)[1], "times", dim(data_filtered)[2]) # 1805653 197

data_filtered_with_distance <- data_filtered %>%
  do(bind_cols(., find_nearest_distance(.)))
paste("dimensions of the data is", dim(data_filtered_with_distance)[1], "times", dim(data_filtered_with_distance)[2]) #1805653 217

```

```{r RUN preprocessing data and statistics, echo=FALSE}

# preprocessing data and statistics

# colors according to slides Marit and plot conventions
pheno_vector_absolut = c("CD163+PDL1-","CD163+PDL1+","CD3+CD8-PD1-", "CD3+CD8-PD1+", "CD3+CD8+PD1-", "CD3+CD8+PD1+","Other","Other PDL1+","PAX5+PDL1-", "PAX5+PDL1+")

colors_absolut = c("magenta", "brown", "red", "blue", "green", "yellow", "gray", "pink", "orange", "cyan")
names(colors_absolut) = pheno_vector_absolut


dim_n = length(pheno_vector_absolut)
dim_m = 2*dim_n + 2
statistics = as.data.frame(matrix(rep(0,dim_n*dim_m),dim_n, dim_m))
colnames(statistics) = c(paste("Area K",pheno_vector_absolut),"Area Kdot", paste("Maxnorm K",pheno_vector_absolut), "Maxnorm Kdot")
rownames(statistics) = pheno_vector_absolut
```

```{r RUN do analyse on all samples, echo = TRUE, eval = TRUE}
# check for each image which pheotypes are missing for overview


source("spatstat_vectra.R")


# colors according to slides Marit and plot conventions
pheno_vector_absolut = c("CD163+PDL1-","CD163+PDL1+","CD3+CD8-PD1-", "CD3+CD8-PD1+", "CD3+CD8+PD1-", "CD3+CD8+PD1+","Other","Other PDL1+","PAX5+PDL1-", "PAX5+PDL1+")

colors_absolut = c("magenta", "brown", "red", "blue", "green", "yellow", "gray", "pink", "orange", "cyan")
names(colors_absolut) = pheno_vector_absolut


# run for one sample name

samples_output = list()


paths <- list_cell_seg_files(
  "C:/Users/erikb/Documents/Thesis - Local/Data Marit voor Erik Bosch/Erik Bosch/Data complete phenotyping/HO105_Exported data tables"
)
paste("There are", length(paths), "different samples currently available.")

samples_output = list()

r_vec = c(20)
# r_vec currently does not work well when given NULL see inside spatstat_vectra

plotter_sample = FALSE
plotter_quadrat = FALSE
plotter_alltypes = TRUE

plotter_bools = c(plotter_sample, plotter_quadrat, plotter_alltypes)


for (samplename_long in paths[1:1]){
  # print(samplename_long)
  # samplename_long = "C:/Users/erikb/Documents/Thesis - Local/Data Marit voor Erik Bosch/Erik Bosch/Data complete phenotyping/HO105_Exported data tables/HO105-194_[16067,37856]_cell_seg_data.txt" # PD-L1 positive cluster + Tumor cluster
  # print(samplename_long)
  # print(paste("path of data is ", samplename))
  data = purrr::map_df(samplename_long, read_cell_seg_data, pixels_per_micron = getOption("phenoptr.pixels.per.micron"))
  
  samplename = str_replace(samplename_long,"C:/Users/erikb/Documents/Thesis - Local/Data Marit voor Erik Bosch/Erik Bosch/Data complete phenotyping/HO105_Exported data tables/","")
  samplename = str_replace(samplename,"_cell_seg_data.txt", "")
  
  output_dir <- file.path("fig", samplename)

  if (!dir.exists(output_dir)){
    dir.create(output_dir)
  } else {
    print("Directory already exists!")
    }

  # stop()
  data_with_distance = data %>%
    do(bind_cols(., find_nearest_distance(.)))
  paste("dimensions of the data with distances is", dim(data_with_distance)[1], "times", dim(data_with_distance)[2])
  
    output =  do_analyse(Intable = data_with_distance, PhenoOrder = pheno_vector_absolut, Cols = colors_absolut, phenotype = NULL, plotter = plotter_bools, fig.prefix = output_dir, XposCol = 'Cell X Position', YposCol = 'Cell Y Position', PhenoCol = 'Phenotype', sample_name = samplename, r_vec = r_vec, options = "F", envelope_bool = TRUE)

  # output =  do_analyse(Intable = data_with_distance, PhenoOrder = pheno_vector_absolut, Cols = colors_absolut, phenotype = NULL, plotter = plotter_bools, fig.prefix = './', XposCol = 'Cell X Position', YposCol = 'Cell Y Position', PhenoCol = 'Phenotype', sample_name = samplename, r_vec = r_vec, options = "G", envelope_bool = TRUE)
  
  samples_output[[samplename]] = output
  # stop()
  
  pairwise_distances = output[[1]]
  counts_sample = output[[2]]
  Area_sample = output[[3]]
  density_sample = output[[4]]
  quadratcount_pvalue = output[[5]]
  MED_min = output[[6]]
  MED = output[[7]]
  MAD_min = output[[8]]
  MAD = output[[9]]
  r_close_list = output[[10]]
  statistic_close_list = output[[11]]
  normalized_list = output[[12]]
  all_types_options_sample_name = output[[13]]
  
  
  
  # browser() # here for Erik to remember this method of debugging
}


```




```{r RUN data for extreme cases: HO105-194}
######### RUN data for extreme cases #########

source("spatstat_vectra.R")


# colors according to slides Marit and plot conventions
pheno_vector_absolut = c("CD163+PDL1-","CD163+PDL1+","CD3+CD8-PD1-", "CD3+CD8-PD1+", "CD3+CD8+PD1-", "CD3+CD8+PD1+","Other","Other PDL1+","PAX5+PDL1-", "PAX5+PDL1+")

colors_absolut = c("magenta", "brown", "red", "blue", "green", "yellow", "gray", "pink", "orange", "cyan")
names(colors_absolut) = pheno_vector_absolut


r_vec = c(10,20)

# run for one sample name

samples_output = list()

# data from Marit: extreme cases

# HO105-194
samplename_path = "C:/Users/erikb/Documents/Thesis - Local/Data Marit voor Erik Bosch/Erik Bosch/Data complete phenotyping/HO105_Exported data tables/HO105-194_[16067,37856]_cell_seg_data.txt" # PD-L1 positive cluster + Tumor cluster

data = purrr::map_df(samplename_path, read_cell_seg_data, pixels_per_micron = getOption("phenoptr.pixels.per.micron"))
data_with_distance = data %>%
  do(bind_cols(., find_nearest_distance(.)))

samplename_path = str_replace(samplename_path,"C:/Users/erikb/Documents/Thesis - Local/Data Marit voor Erik Bosch/Erik Bosch/Data complete phenotyping/HO105_Exported data tables/","")
samplename_path = str_replace(samplename_path,"_cell_seg_data.txt", "")
samplename = samplename_path

output =  do_analyse(Intable = data_with_distance, PhenoOrder = pheno_vector_absolut, Cols = colors_absolut, phenotype = NULL, plotter = c(FALSE,FALSE,FALSE), XposCol = 'Cell X Position', YposCol = 'Cell Y Position', PhenoCol = 'Phenotype', sample_name = samplename, r_vec = r_vec, options = "G", envelope_bool = TRUE)

samples_output[[samplename]] = output



samplename_path = "C:/Users/erikb/Documents/Thesis - Local/Data Marit voor Erik Bosch/Erik Bosch/Data complete phenotyping/HO105_Exported data tables/HO105-194_[15564,37856]_cell_seg_data.txt" # PD-L1 positive cluster + Tumor cluster

data = purrr::map_df(samplename_path, read_cell_seg_data, pixels_per_micron = getOption("phenoptr.pixels.per.micron"))
data_with_distance = data %>%
  do(bind_cols(., find_nearest_distance(.)))

samplename_path = str_replace(samplename_path,"C:/Users/erikb/Documents/Thesis - Local/Data Marit voor Erik Bosch/Erik Bosch/Data complete phenotyping/HO105_Exported data tables/","")
samplename_path = str_replace(samplename_path,"_cell_seg_data.txt", "")
samplename = samplename_path

output =  do_analyse(Intable = data_with_distance, PhenoOrder = pheno_vector_absolut, Cols = colors_absolut, phenotype = NULL, plotter = c(FALSE,FALSE,FALSE), XposCol = 'Cell X Position', YposCol = 'Cell Y Position', PhenoCol = 'Phenotype', sample_name = samplename, r_vec = r_vec, options = "G", envelope_bool = TRUE)

samples_output[[samplename]] = output


samplename_path = "C:/Users/erikb/Documents/Thesis - Local/Data Marit voor Erik Bosch/Erik Bosch/Data complete phenotyping/HO105_Exported data tables/HO105-194_[16029,38205]_cell_seg_data.txt" # not clustered

data = purrr::map_df(samplename_path, read_cell_seg_data, pixels_per_micron = getOption("phenoptr.pixels.per.micron"))
data_with_distance = data %>%
  do(bind_cols(., find_nearest_distance(.)))

samplename_path = str_replace(samplename_path,"C:/Users/erikb/Documents/Thesis - Local/Data Marit voor Erik Bosch/Erik Bosch/Data complete phenotyping/HO105_Exported data tables/","")
samplename_path = str_replace(samplename_path,"_cell_seg_data.txt", "")
samplename = samplename_path

output =  do_analyse(Intable = data_with_distance, PhenoOrder = pheno_vector_absolut, Cols = colors_absolut, phenotype = NULL, plotter = c(FALSE,FALSE,FALSE), XposCol = 'Cell X Position', YposCol = 'Cell Y Position', PhenoCol = 'Phenotype', sample_name = samplename, r_vec = r_vec, options = "G", envelope_bool = TRUE)

samples_output[[samplename]] = output

```

```{r RUN data for extreme cases: HO105-186}
# HO105-186

source("spatstat_vectra.R")


# colors according to slides Marit and plot conventions
pheno_vector_absolut = c("CD163+PDL1-","CD163+PDL1+","CD3+CD8-PD1-", "CD3+CD8-PD1+", "CD3+CD8+PD1-", "CD3+CD8+PD1+","Other","Other PDL1+","PAX5+PDL1-", "PAX5+PDL1+")

colors_absolut = c("magenta", "brown", "red", "blue", "green", "yellow", "gray", "pink", "orange", "cyan")
names(colors_absolut) = pheno_vector_absolut


r_vec = c(10)

# run for one sample name

samples_output = list()

# data from Marit: extreme cases



samplename_path = "C:/Users/erikb/Documents/Thesis - Local/Data Marit voor Erik Bosch/Erik Bosch/Data complete phenotyping/HO105_Exported data tables/HO105-186_[18941,59427]_cell_seg_data.txt" # PD-L1 positive cluster + Tumor cluster

data = purrr::map_df(samplename_path, read_cell_seg_data, pixels_per_micron = getOption("phenoptr.pixels.per.micron"))
data_with_distance = data %>%
  do(bind_cols(., find_nearest_distance(.)))

samplename_path = str_replace(samplename_path,"C:/Users/erikb/Documents/Thesis - Local/Data Marit voor Erik Bosch/Erik Bosch/Data complete phenotyping/HO105_Exported data tables/","")
samplename_path = str_replace(samplename_path,"_cell_seg_data.txt", "")
samplename = samplename_path

output =  do_analyse(Intable = data_with_distance, PhenoOrder = pheno_vector_absolut, Cols = colors_absolut, phenotype = NULL, plotter = c(FALSE,FALSE,FALSE), XposCol = 'Cell X Position', YposCol = 'Cell Y Position', PhenoCol = 'Phenotype', sample_name = samplename, r_vec = r_vec, options = "G", envelope_bool = TRUE)

samples_output[[samplename]] = output



samplename_path = "C:/Users/erikb/Documents/Thesis - Local/Data Marit voor Erik Bosch/Erik Bosch/Data complete phenotyping/HO105_Exported data tables/HO105-186_[18837,59867]_cell_seg_data.txt" # PD-L1 positive cluster + Tumor cluster

data = purrr::map_df(samplename_path, read_cell_seg_data, pixels_per_micron = getOption("phenoptr.pixels.per.micron"))
data_with_distance = data %>%
  do(bind_cols(., find_nearest_distance(.)))

samplename_path = str_replace(samplename_path,"C:/Users/erikb/Documents/Thesis - Local/Data Marit voor Erik Bosch/Erik Bosch/Data complete phenotyping/HO105_Exported data tables/","")
samplename_path = str_replace(samplename_path,"_cell_seg_data.txt", "")
samplename = samplename_path

output =  do_analyse(Intable = data_with_distance, PhenoOrder = pheno_vector_absolut, Cols = colors_absolut, phenotype = NULL, plotter = c(FALSE,FALSE,FALSE), XposCol = 'Cell X Position', YposCol = 'Cell Y Position', PhenoCol = 'Phenotype', sample_name = samplename, r_vec = r_vec, options = "G", envelope_bool = TRUE)

samples_output[[samplename]] = output



samplename_path = "C:/Users/erikb/Documents/Thesis - Local/Data Marit voor Erik Bosch/Erik Bosch/Data complete phenotyping/HO105_Exported data tables/HO105-186_[18127,59130]_cell_seg_data.txt" # PD-L1 positive cluster + Tumor cluster

data = purrr::map_df(samplename_path, read_cell_seg_data, pixels_per_micron = getOption("phenoptr.pixels.per.micron"))
data_with_distance = data %>%
  do(bind_cols(., find_nearest_distance(.)))

samplename_path = str_replace(samplename_path,"C:/Users/erikb/Documents/Thesis - Local/Data Marit voor Erik Bosch/Erik Bosch/Data complete phenotyping/HO105_Exported data tables/","")
samplename_path = str_replace(samplename_path,"_cell_seg_data.txt", "")
samplename = samplename_path

output =  do_analyse(Intable = data_with_distance, PhenoOrder = pheno_vector_absolut, Cols = colors_absolut, phenotype = NULL, plotter = c(FALSE,FALSE,FALSE), XposCol = 'Cell X Position', YposCol = 'Cell Y Position', PhenoCol = 'Phenotype', sample_name = samplename, r_vec = r_vec, options = "G", envelope_bool = TRUE)

samples_output[[samplename]] = output



samplename_path = "C:/Users/erikb/Documents/Thesis - Local/Data Marit voor Erik Bosch/Erik Bosch/Data complete phenotyping/HO105_Exported data tables/HO105-186_[14661,55645]_cell_seg_data.txt" # PD-L1 positive cluster + Tumor cluster

data = purrr::map_df(samplename_path, read_cell_seg_data, pixels_per_micron = getOption("phenoptr.pixels.per.micron"))
data_with_distance = data %>%
  do(bind_cols(., find_nearest_distance(.)))

samplename_path = str_replace(samplename_path,"C:/Users/erikb/Documents/Thesis - Local/Data Marit voor Erik Bosch/Erik Bosch/Data complete phenotyping/HO105_Exported data tables/","")
samplename_path = str_replace(samplename_path,"_cell_seg_data.txt", "")
samplename = samplename_path

output =  do_analyse(Intable = data_with_distance, PhenoOrder = pheno_vector_absolut, Cols = colors_absolut, phenotype = NULL, plotter = c(FALSE,FALSE,FALSE), XposCol = 'Cell X Position', YposCol = 'Cell Y Position', PhenoCol = 'Phenotype', sample_name = samplename, r_vec = r_vec, options = "G", envelope_bool = TRUE)

samples_output[[samplename]] = output



samplename_path = "C:/Users/erikb/Documents/Thesis - Local/Data Marit voor Erik Bosch/Erik Bosch/Data complete phenotyping/HO105_Exported data tables/HO105-186_[14121,55575]_cell_seg_data.txt" # PD-L1 positive cluster + Tumor cluster

data = purrr::map_df(samplename_path, read_cell_seg_data, pixels_per_micron = getOption("phenoptr.pixels.per.micron"))
data_with_distance = data %>%
  do(bind_cols(., find_nearest_distance(.)))

samplename_path = str_replace(samplename_path,"C:/Users/erikb/Documents/Thesis - Local/Data Marit voor Erik Bosch/Erik Bosch/Data complete phenotyping/HO105_Exported data tables/","")
samplename_path = str_replace(samplename_path,"_cell_seg_data.txt", "")
samplename = samplename_path

output =  do_analyse(Intable = data_with_distance, PhenoOrder = pheno_vector_absolut, Cols = colors_absolut, phenotype = NULL, plotter = c(FALSE,FALSE,FALSE), XposCol = 'Cell X Position', YposCol = 'Cell Y Position', PhenoCol = 'Phenotype', sample_name = samplename, r_vec = r_vec, options = "G", envelope_bool = TRUE)

samples_output[[samplename]] = output

view(samples_output)
```

```{r RUN data for extreme cases: HO105-101}
# HO105-101
source("spatstat_vectra.R")


# colors according to slides Marit and plot conventions
pheno_vector_absolut = c("CD163+PDL1-","CD163+PDL1+","CD3+CD8-PD1-", "CD3+CD8-PD1+", "CD3+CD8+PD1-", "CD3+CD8+PD1+","Other","Other PDL1+","PAX5+PDL1-", "PAX5+PDL1+")

colors_absolut = c("magenta", "brown", "red", "blue", "green", "yellow", "gray", "pink", "orange", "cyan")
names(colors_absolut) = pheno_vector_absolut


r_vec = c(10,20)

# run for one sample name

samples_output = list()


samplename_path = "C:/Users/erikb/Documents/Thesis - Local/Data Marit voor Erik Bosch/Erik Bosch/Data complete phenotyping/HO105_Exported data tables/HO105-101_[9072,46519]_cell_seg_data.txt" # Spreadout Tumor

data = purrr::map_df(samplename_path, read_cell_seg_data, pixels_per_micron = getOption("phenoptr.pixels.per.micron"))
data_with_distance = data %>%
  do(bind_cols(., find_nearest_distance(.)))

samplename_path = str_replace(samplename_path,"C:/Users/erikb/Documents/Thesis - Local/Data Marit voor Erik Bosch/Erik Bosch/Data complete phenotyping/HO105_Exported data tables/","")
samplename_path = str_replace(samplename_path,"_cell_seg_data.txt", "")
samplename = samplename_path

output =  do_analyse(Intable = data_with_distance, PhenoOrder = pheno_vector_absolut, Cols = colors_absolut, phenotype = NULL, plotter = c(FALSE,FALSE,FALSE), XposCol = 'Cell X Position', YposCol = 'Cell Y Position', PhenoCol = 'Phenotype', sample_name = samplename, r_vec = r_vec, options = "G", envelope_bool = TRUE)

samples_output[[samplename]] = output

view(samples_output)
```

```{r RUN data for extreme cases: HO105-150}
# HO105-150
source("spatstat_vectra.R")


# colors according to slides Marit and plot conventions
pheno_vector_absolut = c("CD163+PDL1-","CD163+PDL1+","CD3+CD8-PD1-", "CD3+CD8-PD1+", "CD3+CD8+PD1-", "CD3+CD8+PD1+","Other","Other PDL1+","PAX5+PDL1-", "PAX5+PDL1+")

colors_absolut = c("magenta", "brown", "red", "blue", "green", "yellow", "gray", "pink", "orange", "cyan")
names(colors_absolut) = pheno_vector_absolut


r_vec = c(10)

# run for one sample name

samples_output = list()


samplename_path = "C:/Users/erikb/Documents/Thesis - Local/Data Marit voor Erik Bosch/Erik Bosch/Data complete phenotyping/HO105_Exported data tables/HO105-150_[13112,45808]_cell_seg_data.txt" # Spreadout Tumor

data = purrr::map_df(samplename_path, read_cell_seg_data, pixels_per_micron = getOption("phenoptr.pixels.per.micron"))
data_with_distance = data %>%
  do(bind_cols(., find_nearest_distance(.)))

samplename_path = str_replace(samplename_path,"C:/Users/erikb/Documents/Thesis - Local/Data Marit voor Erik Bosch/Erik Bosch/Data complete phenotyping/HO105_Exported data tables/","")
samplename_path = str_replace(samplename_path,"_cell_seg_data.txt", "")
samplename = samplename_path

output =  do_analyse(Intable = data_with_distance, PhenoOrder = pheno_vector_absolut, Cols = colors_absolut, phenotype = NULL, plotter = c(FALSE,FALSE,FALSE), XposCol = 'Cell X Position', YposCol = 'Cell Y Position', PhenoCol = 'Phenotype', sample_name = samplename, r_vec = r_vec, options = "G", envelope_bool = TRUE)

samples_output[[samplename]] = output


# view(samples_output)
```

```{r RUN data for extreme cases: HO105-120}
# HO105-120
source("spatstat_vectra.R")


# colors according to slides Marit and plot conventions
pheno_vector_absolut = c("CD163+PDL1-","CD163+PDL1+","CD3+CD8-PD1-", "CD3+CD8-PD1+", "CD3+CD8+PD1-", "CD3+CD8+PD1+","Other","Other PDL1+","PAX5+PDL1-", "PAX5+PDL1+")

colors_absolut = c("magenta", "brown", "red", "blue", "green", "yellow", "gray", "pink", "orange", "cyan")
names(colors_absolut) = pheno_vector_absolut


r_vec = c(10,20)

# run for one sample name

samples_output = list()

samplename_path = "C:/Users/erikb/Documents/Thesis - Local/Data Marit voor Erik Bosch/Erik Bosch/Data complete phenotyping/HO105_Exported data tables/HO105-120_[5524,47985]_cell_seg_data.txt" # Spreadout Tumor

data = purrr::map_df(samplename_path, read_cell_seg_data, pixels_per_micron = getOption("phenoptr.pixels.per.micron"))
data_with_distance = data %>%
  do(bind_cols(., find_nearest_distance(.)))

samplename_path = str_replace(samplename_path,"C:/Users/erikb/Documents/Thesis - Local/Data Marit voor Erik Bosch/Erik Bosch/Data complete phenotyping/HO105_Exported data tables/","")
samplename_path = str_replace(samplename_path,"_cell_seg_data.txt", "")
samplename = samplename_path

output =  do_analyse(Intable = data_with_distance, PhenoOrder = pheno_vector_absolut, Cols = colors_absolut, phenotype = NULL, plotter = c(FALSE,FALSE,FALSE), XposCol = 'Cell X Position', YposCol = 'Cell Y Position', PhenoCol = 'Phenotype', sample_name = samplename, r_vec = r_vec, options = "G", envelope_bool = TRUE)

samples_output[[samplename]] = output


view(samples_output)
```

```{r RUN data for extreme cases: HO105-107}
# HO105-107
source("spatstat_vectra.R")


# colors according to slides Marit and plot conventions
pheno_vector_absolut = c("CD163+PDL1-","CD163+PDL1+","CD3+CD8-PD1-", "CD3+CD8-PD1+", "CD3+CD8+PD1-", "CD3+CD8+PD1+","Other","Other PDL1+","PAX5+PDL1-", "PAX5+PDL1+")

colors_absolut = c("magenta", "brown", "red", "blue", "green", "yellow", "gray", "pink", "orange", "cyan")
names(colors_absolut) = pheno_vector_absolut


r_vec = c(10)

# run for one sample name

samples_output = list()

samplename_path = "C:/Users/erikb/Documents/Thesis - Local/Data Marit voor Erik Bosch/Erik Bosch/Data complete phenotyping/HO105_Exported data tables/HO105-107_[11070,34907]_cell_seg_data.txt" # T-cell cluster

data = purrr::map_df(samplename_path, read_cell_seg_data, pixels_per_micron = getOption("phenoptr.pixels.per.micron"))
data_with_distance = data %>%
  do(bind_cols(., find_nearest_distance(.)))

samplename_path = str_replace(samplename_path,"C:/Users/erikb/Documents/Thesis - Local/Data Marit voor Erik Bosch/Erik Bosch/Data complete phenotyping/HO105_Exported data tables/","")
samplename_path = str_replace(samplename_path,"_cell_seg_data.txt", "")
samplename = samplename_path

output =  do_analyse(Intable = data_with_distance, PhenoOrder = pheno_vector_absolut, Cols = colors_absolut, phenotype = NULL, plotter = c(FALSE,FALSE,FALSE), XposCol = 'Cell X Position', YposCol = 'Cell Y Position', PhenoCol = 'Phenotype', sample_name = samplename, r_vec = r_vec, options = "G", envelope_bool = TRUE)

samples_output[[samplename]] = output


view(samples_output)
```

```{r RUN data for extreme cases: HO105-171_3}
# HO105-171_3
source("spatstat_vectra.R")


# colors according to slides Marit and plot conventions
pheno_vector_absolut = c("CD163+PDL1-","CD163+PDL1+","CD3+CD8-PD1-", "CD3+CD8-PD1+", "CD3+CD8+PD1-", "CD3+CD8+PD1+","Other","Other PDL1+","PAX5+PDL1-", "PAX5+PDL1+")

colors_absolut = c("magenta", "brown", "red", "blue", "green", "yellow", "gray", "pink", "orange", "cyan")
names(colors_absolut) = pheno_vector_absolut


r_vec = c(10,20)

# run for one sample name

samples_output = list()


samplename_path = "C:/Users/erikb/Documents/Thesis - Local/Data Marit voor Erik Bosch/Erik Bosch/Data complete phenotyping/HO105_Exported data tables/HO105-171_3_[6297,46984]_cell_seg_data.txt" # T-cell cluster surrounded by Other

data = purrr::map_df(samplename_path, read_cell_seg_data, pixels_per_micron = getOption("phenoptr.pixels.per.micron"))
data_with_distance = data %>%
  do(bind_cols(., find_nearest_distance(.)))

samplename_path = str_replace(samplename_path,"C:/Users/erikb/Documents/Thesis - Local/Data Marit voor Erik Bosch/Erik Bosch/Data complete phenotyping/HO105_Exported data tables/","")
samplename_path = str_replace(samplename_path,"_cell_seg_data.txt", "")
samplename = samplename_path

output =  do_analyse(Intable = data_with_distance, PhenoOrder = pheno_vector_absolut, Cols = colors_absolut, phenotype = NULL, plotter = c(FALSE,FALSE,FALSE), XposCol = 'Cell X Position', YposCol = 'Cell Y Position', PhenoCol = 'Phenotype', sample_name = samplename, r_vec = r_vec, options = "G", envelope_bool = TRUE)

samples_output[[samplename]] = output



samplename_path = "C:/Users/erikb/Documents/Thesis - Local/Data Marit voor Erik Bosch/Erik Bosch/Data complete phenotyping/HO105_Exported data tables/HO105-171_3_[12870,46254]_cell_seg_data.txt" # T-cell cluster surrounded by Other

data = purrr::map_df(samplename_path, read_cell_seg_data, pixels_per_micron = getOption("phenoptr.pixels.per.micron"))
data_with_distance = data %>%
  do(bind_cols(., find_nearest_distance(.)))

samplename_path = str_replace(samplename_path,"C:/Users/erikb/Documents/Thesis - Local/Data Marit voor Erik Bosch/Erik Bosch/Data complete phenotyping/HO105_Exported data tables/","")
samplename_path = str_replace(samplename_path,"_cell_seg_data.txt", "")
samplename = samplename_path

output =  do_analyse(Intable = data_with_distance, PhenoOrder = pheno_vector_absolut, Cols = colors_absolut, phenotype = NULL, plotter = c(FALSE,FALSE,FALSE), XposCol = 'Cell X Position', YposCol = 'Cell Y Position', PhenoCol = 'Phenotype', sample_name = samplename, r_vec = r_vec, options = "G", envelope_bool = TRUE)

samples_output[[samplename]] = output


view(samples_output)
```

